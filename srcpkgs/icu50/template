# Template build file for 'icu'.
pkgname=icu50
version=50.1.2
revision=6
wrksrc=icu
build_wrksrc=source
build_style=gnu-configure
short_desc="Robust and full-featured Unicode services"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.icu-project.org/"
license="ICU License /usr/share/licenses/icu/license.html"
distfiles="https://github.com/unicode-org/icu/archive/icu-release-${version//./-}.tar.gz"
checksum=1bac306d493fce8c3d0c31e4aa1abcda3da7bf3ceff86ae12fd70bd752e7a932
hostmakedepends="gcc4"
nopie_files="/usr/bin/pkgdata /usr/bin/uconv /usr/bin/genccode /usr/bin/derb /usr/bin/genrb /usr/bin/icuinfo /usr/bin/gencfu /usr/bin/icupkg /usr/bin/gencnval /usr/bin/gencmn /usr/bin/makeconv /usr/bin/gendict /usr/bin/gennorm2 /usr/bin/genrb /usr/bin/gensprep /usr/bin/icuinfo /usr/bin/icupkg /usr/bin/makeconv /usr/bin/pkgdata /usr/bin/uconv /usr/bin/genbrk"
noverifyrdeps=yes
noshlibprovides=yes

if [ "$CROSS_BUILD" ]; then
	configure_args+=" --with-cross-build=${XBPS_BUILDDIR}/${wrksrc}/host-icu"
fi

post_extract() {
	mv ${XBPS_BUILDDIR}/icu-icu-release-${version//./-} ${XBPS_BUILDDIR}/icu
}

pre_configure() {
	CXX=g++-4
	CC=gcc-4
	
	# remove option not supported by clang
	CFLAGS=${CFLAGS/-fstack-clash-protection/}
	CXXFLAGS=${CXXFLAGS/-fstack-clash-protection/}
	
	if [ "$CROSS_BUILD" ]; then
		# Configure and build for host.
		mkdir host-build
		cd host-build
		env CC=$CC LD=ld CXX=$CXX AR=ar RANLIB=ranlib \
			AS=as STRIP=strip CFLAGS="-Os" CXXFLAGS="-Os" \
			../configure --disable-default-pie --prefix=/
		make ${makejobs}
		mkdir -p ${wrksrc}/host-icu/config
		cp config/icucross.mk ${wrksrc}/host-icu/config
		make DESTDIR=${wrksrc}/host-icu install
		mv ${wrksrc}/host-icu/sbin/* ${wrksrc}/host-icu/bin
		# libicudata must be linked to libc, otherwise it's soft-float.
		# See https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=653457
		sed -e 's,-nostdlib,,g' -i ${wrksrc}/source/config/mh-linux
	fi
}

post_install() {
	vinstall $wrksrc/license.html 644 usr/share/licenses/icu
}

icu50-devel_package() {
	depends="libstdc++-devel icu50-libs>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/icu
		vmove usr/lib/pkgconfig
		vmove usr/share/icu
		vmove usr/bin/icu-config
		vmove "usr/share/man/man1/icu-config*"
		vmove "usr/lib/*.so"
	}
}

icu50-libs_package() {
	short_desc+=" - shared libs"
	pkg_install() {
		vmove "usr/lib/*.so.*"
	}
}
